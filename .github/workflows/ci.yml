name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  rust:
    name: Rust tests + lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt
      - uses: Swatinem/rust-cache@v2
      - run: cargo fmt --check
      - run: cargo clippy -- -D warnings
      - run: cargo test --workspace

  typescript:
    name: TypeScript tests + typecheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown
      - uses: Swatinem/rust-cache@v2
      - uses: jetli/wasm-pack-action@v0.4.0
      - uses: actions/setup-node@v4
        with:
          node-version: "24"
          cache: "npm"
          cache-dependency-path: ts/package-lock.json
      - run: wasm-pack build --target nodejs --out-dir ../../ts/pkg crates/solar-line-wasm
      - run: npm ci
        working-directory: ts
      - run: npm run typecheck
        working-directory: ts
      - run: npm test
        working-directory: ts

  e2e:
    name: Playwright E2E tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "24"
          cache: "npm"
          cache-dependency-path: ts/package-lock.json
      - run: npm ci
        working-directory: ts
      - run: npx playwright install --with-deps chromium
        working-directory: ts
      - run: npm run build
        working-directory: ts
      - run: npx playwright test
        working-directory: ts

  cross-validate:
    name: Cross-validate orbital mechanics (Python)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - run: python3 -m venv .venv && .venv/bin/pip install numpy scipy
      - run: |
          cargo test --test cross_validation_export -- --nocapture 2>/dev/null \
            | grep -v '^running\|^test \|^$\|test result' \
            > cross_validation/rust_values.json
      - run: .venv/bin/python3 cross_validation/validate.py

  wasm-web:
    name: WASM browser build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown
      - uses: Swatinem/rust-cache@v2
      - uses: jetli/wasm-pack-action@v0.4.0
      - run: wasm-pack build --target web --out-dir ../../ts/pkg crates/solar-line-wasm
