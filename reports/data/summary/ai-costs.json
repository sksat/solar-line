{
  "slug": "ai-costs",
  "title": "AI コスト分析",
  "summary": "Claude Code エージェントループのトークン使用量・コスト内訳・キャッシュ効率の分析。プロジェクト全体のAIコストパフォーマンスを可視化する。",
  "sections": [
    {
      "heading": "概要",
      "markdown": "SOLAR LINE 考察プロジェクトは、Claude Code エージェントが自律的に開発しています。本ページでは、そのAI利用コストを分析します。\n\n### 主要指標\n\n| 指標 | 値 |\n|------|------|\n| 総トークン数 | 約3.6億 |\n| サブエージェントコスト（Haiku） | $6.57 |\n| メインセッションコスト（Opus） | $0（Maxサブスク） |\n| キャッシュヒット率 | 97.3% |\n| ツール呼び出し回数 | 4,675回 |\n| サブエージェント起動数 | 120回 |\n\n*注: 上記は1回のVMブート（58セッション）からのサンプルデータです。*"
    },
    {
      "heading": "トークン分布",
      "markdown": "トークン使用量の97.3%がキャッシュ読み取りで、非常に効率的なキャッシュ活用を実現しています。\n\n| カテゴリ | 割合 |\n|---------|------|\n| キャッシュ読み取り | 97.3% |\n| キャッシュ作成 | 2.7% |\n| 実I/O（有用作業） | <0.1% |\n\n実質的な「仕事」はトークン全体のごくわずかです。残りはコンテキスト維持のためのキャッシュ操作が占めています。"
    },
    {
      "heading": "コスト内訳",
      "markdown": "測定可能なコスト（$6.57）の100%がHaikuサブエージェントから発生しています。Opusメインセッションは Max サブスクリプションに含まれるため追加コストなし。\n\n### モデル別使用状況\n\n| モデル | 起動回数 | トークン割合 | コスト |\n|--------|---------|------------|--------|\n| Haiku | 95回 (79%) | 72% | $6.57 |\n| Sonnet | 13回 (11%) | 21% | $0* |\n| Opus | 12回 (10%) | 7% | $0* |\n\n*Maxサブスクリプション対象のため追加コストなし\n\n### サブエージェントの特性\n\n各サブエージェントは平均して:\n- 約83万6千トークンを消費（大部分はキャッシュ読み取り）\n- 約16回のツール呼び出しを実行\n- 88%が読み取り専用の探索タスク"
    },
    {
      "heading": "効率化施策",
      "markdown": "### 実施済み\n\n1. **TodoWrite頻度の削減**: 状態遷移時のみ更新するよう CLAUDE.md に明記。全ツール呼び出しの9.8%を占めていた\n2. **サブエージェントのデフォルトモデル**: 探索・リサーチ用はHaikuをデフォルト指定\n3. **バックグラウンド実行**: Whisper、yt-dlp等の長時間コマンドは `run_in_background` を使用\n4. **サブエージェントのスコープ制限**: `max_turns` でTool呼び出し回数を制限\n5. **ワークフローのSkill化**: 繰り返しパターンをSkillとして定義（episode-analysis, subtitle-extraction, report-review, cost-analysis）\n\n### 効果\n\n| 施策 | 影響度 | 節約見込み |\n|------|--------|----------|\n| TodoWrite頻度削減 | 高 | 200コンテキストターン/日 |\n| Haikuデフォルト化 | 中 | トークン単価の削減 |\n| バックグラウンド実行 | 中 | セッションサイズ削減 |\n| Read/Grep優先 | 中 | サブエージェント効率化 |\n| max_turns制限 | 低-中 | 暴走防止 |"
    },
    {
      "heading": "プロジェクト全体のコスト見積もり",
      "markdown": "### 推定パラメータ\n\nプロジェクト全体（85+タスク、100+コミット）で:\n\n- 1回のVMブートあたり約58セッション\n- 1回のVMブートあたり約$6.50（Haikuサブエージェント分）\n- Opus使用分: $0（Maxサブスクリプション）\n- 複数回のVMブート × $6.50\n\n### コスト効率の評価\n\nキャッシュヒット率 **97.3%** は非常に優秀です。これは Claude Code のコンテキスト管理が効果的に機能していることを示しています。\n\n主な最適化ポイントは:\n- 不要なコンテキスト更新の削減（TodoWrite頻度）\n- ストリーミング出力によるセッション膨張の防止\n- サブエージェントの適切なモデル選択\n\n### 更新方法\n\n```\n# ccusageでコストデータを取得:\nbunx ccusage@17 session --offline --json --timezone Asia/Tokyo | \\\n  npm run analyze-costs -- --mode session\n\n# 日別サマリー:\nbunx ccusage@17 daily --offline --json --timezone Asia/Tokyo | \\\n  npm run analyze-costs -- --mode daily\n```"
    }
  ]
}
