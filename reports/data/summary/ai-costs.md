---
slug: ai-costs
title: AI コスト分析
summary: Claude Code エージェントループのトークン使用量・コスト内訳・キャッシュ効率の分析。プロジェクト全体のAIコストパフォーマンスを可視化する。
category: meta
---

## 概要

SOLAR LINE 考察プロジェクトは、Claude Code エージェントが自律的に開発しています。本ページでは、そのAI利用コストを分析します。

### 主要指標

| 指標 | 値 |
|------|------|
| 総トークン数 | 約3.6億 |
| サブエージェントコスト（Haiku） | $6.57 |
| メインセッションコスト（Opus） | $0（Maxサブスク） |
| キャッシュヒット率 | 97.3% |
| ツール呼び出し回数 | 4,675回 |
| サブエージェント起動数 | 120回 |

*注: 上記は1回のVMブート（58セッション）からのサンプルデータです。*

## トークン分布

トークン使用量の97.3%がキャッシュ読み取りで、非常に効率的なキャッシュ活用を実現しています。

| カテゴリ | 割合 |
|---------|------|
| キャッシュ読み取り | 97.3% |
| キャッシュ作成 | 2.7% |
| 実I/O（有用作業） | <0.1% |

実質的な「仕事」はトークン全体のごくわずかです。残りはコンテキスト維持のためのキャッシュ操作が占めています。

## コスト内訳

測定可能なコスト（$6.57）の100%がHaikuサブエージェントから発生しています。Opusメインセッションは Max サブスクリプションに含まれるため追加コストなし。

### モデル別使用状況

| モデル | 起動回数 | トークン割合 | コスト |
|--------|---------|------------|--------|
| Haiku | 95回 (79%) | 72% | $6.57 |
| Sonnet | 13回 (11%) | 21% | $0* |
| Opus | 12回 (10%) | 7% | $0* |

*Maxサブスクリプション対象のため追加コストなし

### サブエージェントの特性

各サブエージェントは平均して:
- 約83万6千トークンを消費（大部分はキャッシュ読み取り）
- 約16回のツール呼び出しを実行
- 88%が読み取り専用の探索タスク

## 効率化施策

### 実施済み

1. **TodoWrite頻度の削減**: 状態遷移時のみ更新するよう CLAUDE.md に明記。全ツール呼び出しの9.8%を占めていた
2. **サブエージェントのデフォルトモデル**: 探索・リサーチ用はHaikuをデフォルト指定
3. **バックグラウンド実行**: Whisper、yt-dlp等の長時間コマンドは `run_in_background` を使用
4. **サブエージェントのスコープ制限**: `max_turns` でTool呼び出し回数を制限
5. **ワークフローのSkill化**: 繰り返しパターンをSkillとして定義（episode-analysis, subtitle-extraction, report-review, cost-analysis）

### 効果

| 施策 | 影響度 | 節約見込み |
|------|--------|----------|
| TodoWrite頻度削減 | 高 | 200コンテキストターン/日 |
| Haikuデフォルト化 | 中 | トークン単価の削減 |
| バックグラウンド実行 | 中 | セッションサイズ削減 |
| Read/Grep優先 | 中 | サブエージェント効率化 |
| max_turns制限 | 低-中 | 暴走防止 |

## プラン別コスト比較

もし Max サブスクリプション以外のプランで同じ作業を行った場合のコスト見積もりです。API 料金は2026年2月時点の公式価格に基づきます。

### 料金体系

| モデル | 入力 | 出力 | キャッシュ読取 | キャッシュ書込 |
|--------|------|------|--------------|-------------|
| Opus 4.6 | $5/MTok | $25/MTok | $0.50/MTok | $6.25/MTok |
| Sonnet 4.6 | $3/MTok | $15/MTok | $0.30/MTok | $3.75/MTok |
| Haiku 4.5 | $1/MTok | $5/MTok | $0.10/MTok | $1.25/MTok |

### プラン別推定コスト（58セッション分）

| プラン | 総コスト | 1セッション平均 | 備考 |
|--------|---------|----------------|------|
| **Max Plan** | **~$7 + 月額$100-200** | **$0.12** | Opusは月額に含まれる |
| **API-only** | **~$196** | **~$3.39** | 全トークンがAPI課金 |
| Batch API | ~$195 | ~$3.36 | 入出力50%引（非対話型のみ） |
| Pro Plan + API | $20 + ~$196 | — | レート制限あり、非実用的 |

### API-only の内訳

| 用途 | トークン | コスト |
|------|---------|--------|
| Opus メインセッション (260M) | キャッシュ読取97.3% | ~$174 |
| Haiku サブエージェント (72M) | キャッシュ読取97.3% | ~$10 |
| Sonnet サブエージェント (21M) | キャッシュ読取97.3% | ~$8 |
| Opus サブエージェント (7M) | キャッシュ読取97.3% | ~$5 |
| **合計** | **360M** | **~$196** |

### 分析

**キャッシュが極めて重要**: 97.3%のキャッシュヒット率により、Opus の実質的な入力単価は $0.50/MTok（基本料金の10分の1）となっている。これがなければAPI-onlyコストは数千ドルに膨らむ。

**Max Plan の効果**: 月額$100-200のサブスクリプションで約$196分のAPI利用が含まれる。1回のVMブートで回収できる計算であり、エージェントループ型の開発には非常に費用対効果が高い。

**Pro Plan は非実用的**: Pro Plan ($20/mo) はレート制限があり、エージェントループの速度を維持できない。超過分はAPI課金となるため、結局API-only以上のコストになる可能性がある。

## プロジェクト全体のコスト見積もり

### 推定パラメータ

プロジェクト全体（87+タスク、100+コミット）で:

- 1回のVMブートあたり約58セッション
- 1回のVMブートあたり約$6.50（Haikuサブエージェント分）
- Opus使用分: $0（Maxサブスクリプション）
- 複数回のVMブート × $6.50

### コスト効率の評価

キャッシュヒット率 **97.3%** は非常に優秀です。これは Claude Code のコンテキスト管理が効果的に機能していることを示しています。

主な最適化ポイントは:
- 不要なコンテキスト更新の削減（TodoWrite頻度）
- ストリーミング出力によるセッション膨張の防止
- サブエージェントの適切なモデル選択

### 更新方法

```
# ccusageでコストデータを取得:
bunx ccusage@17 session --offline --json --timezone Asia/Tokyo | \
  npm run analyze-costs -- --mode session

# 日別サマリー:
bunx ccusage@17 daily --offline --json --timezone Asia/Tokyo | \
  npm run analyze-costs -- --mode daily
```
