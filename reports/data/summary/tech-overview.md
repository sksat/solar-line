---
slug: tech-overview
title: 技術解説: SOLAR LINE 考証の仕組み
summary: 本プロジェクトの技術アーキテクチャ — Rust軌道力学コア、WASM、TypeScript静的サイト生成、Claude Codeエージェントループによる自律開発を解説する。
category: meta
---

## プロジェクト概要

SOLAR LINE 考証は、SFアニメ「SOLAR LINE」に描かれた軌道遷移を宇宙力学的に検証するプロジェクトです。

全5話に登場する24の軌道遷移について、実際の物理法則に基づくΔV計算・加速度分析を行い、描写の妥当性を検証しています。単に「正しい/間違い」を判定するだけでなく、**どのような条件なら描写が成立するか**をパラメータ空間の探索を通じて明らかにすることを目指しています。

本ページでは、この考証を支える技術的な仕組みを解説します。

## 現状サマリー

### 進捗

| 指標 | 値 |
|------|------|
| 完了タスク | 92 / 93 |
| 分析済み軌道遷移 | 24 / 24（全話完了） |
| テスト数 | 1,284（TS 1,004 + Rust 206 + E2E 74、0 failures） |
| コミット数 | 149 |
| ADR（設計意思決定記録） | 14件 |
| DAGノード | 64（317エッジ） |

### 判定結果

| 判定 | 件数 |
|------|------|
| plausible（妥当） | 10 |
| conditional（条件付き妥当） | 9 |
| reference（参考） | 5 |
| implausible（非現実的） | 0 |

24件の軌道遷移で **非現実的な判定はゼロ**。ただし[マージン連鎖分析](/summary/cross-episode.html)によると、条件付き判定の連鎖を考慮した場合の全行程成功確率は約30-46%。

### 今後のタスク

- **話者分離**: Speaker Diarization によるPhase 2 精度向上

### 完了済みの主要タスク（最近）

- ✅ **姿勢制御精度の分析**: 推力ベクトル指向精度、フリップ機動ダイナミクス（Task 064）
- ✅ **他の宇宙船・係留地の分析**: 4種の船舶・4つの係留地・統治機構の軌道力学（Task 087）
- ✅ **適応積分手法**: RK45 Dormand-Prince + Störmer-Verlet シンプレクティック積分（Task 063）
- ✅ **軌道パターンのアニメーション**: 複数パターン同時比較図（Task 058）
- ✅ **通信解析**: 光速遅延・リンクバジェット・全5話の通信描写検証（Task 065）
- ✅ **物語的妥当性レビュー**: 全24遷移の視聴者体験との整合性検証（Task 091）

### 設計意思決定（ADR）

14件の[Architecture Decision Records](https://github.com/sksat/solar-line/tree/main/adr)で、プロジェクトの設計ポリシーを文書化しています。

## アーキテクチャ全体像

システムは3層構成です:

1. **Rust 軌道力学コア** (`solar-line-core`): 軌道計算の正確性を保証
2. **WASM ブリッジ** (`solar-line-wasm`): ブラウザでも同じ計算を再現
3. **TypeScript レポート生成** (`ts/`): JSON分析データ → 静的HTMLサイト

この構成により、レポート上のインタラクティブ計算機で読者が自らパラメータを変更して検証でき、計算結果がRustとTypeScript間で一貫していることが保証されます。

## Rust 軌道力学コア

**ゼロ外部依存**で構築された軌道力学ライブラリです。WASM互換性のために外部クレートを使わず、すべての数学関数を自前で実装しています。

### 主要モジュール

- **`units.rs`**: ニュータイプパターンによる型安全な単位系（Km, KmPerSec, Seconds, Radians）。km と km/s を混同するバグを型レベルで防止
- **`orbits.rs`**: vis-viva方程式、Hohmann遷移ΔV、Brachistochrone航法（加速度・ΔV・最大距離）、排気速度、質量比、Oberth効果
- **`kepler.rs`**: Kepler方程式の Newton-Raphson 求解、離心近点角・真近点角の変換
- **`ephemeris.rs`**: JPL平均軌道要素による惑星位置計算、位相角、会合周期、Hohmannウィンドウ
- **`propagation.rs`**: RK4 + RK45 Dormand-Prince 適応ステップ + Störmer-Verlet シンプレクティック軌道伝播。2体問題 + 推力モデル、エネルギー・角運動量保存の検証
- **`flyby.rs`**: パッチドコニック重力アシスト（SOI半径、動力/無動力フライバイ、脱出速度計算）
- **`attitude.rs`**: 姿勢制御精度（ミス距離、フリップ機動、RCSトルク、重力傾斜トルク）
- **`comms.rs`**: 光速遅延、自由空間伝搬損失、通信可能性判定

206のユニットテストで正確性を保証しています。

## WASM ブリッジ

Rust コアを `wasm-pack` でWebAssemblyにコンパイルし、ブラウザ上のインタラクティブ計算機から利用可能にしています。

### 設計方針: Flat f64 API

WASM の境界を越える際に複雑なデータ構造の受け渡しを避け、すべての関数が `f64` のスカラー値を受け取り返す設計です。ニュータイプの wrapping/unwrapping はWASM境界で行います。

```
// TypeScript側
const dv = wasm.brachistochrone_dv(distance_km, time_seconds);

// WASM内部
pub fn brachistochrone_dv(distance: f64, time: f64) -> f64 {
    core::brachistochrone_dv(Km(distance), Seconds(time)).value()
}
```

この設計により、TypeScript 側では型変換の複雑さを意識せず、Rust 側では型安全性を維持できます。

## レポート生成パイプライン

分析結果は構造化されたJSONファイルとして管理され、TypeScriptの静的サイト生成パイプラインでHTMLに変換されます。

### データフロー

1. **JSON 分析データ** (`reports/data/`): エピソードごとの軌道遷移、パラメータ探索、台詞引用、軌道図定義
2. **テンプレートエンジン** (`ts/src/templates.ts`): 純粋な文字列補間による外部依存ゼロのHTML生成
3. **ビルド** (`npm run build`): JSONを読み込み、全ページを `dist/` に出力
4. **GitHub Pages**: `main` へのpush時に自動デプロイ

### 主要な機能

- **Markdown → HTML変換**: 見出し、リスト、テーブル、コードブロック、KaTeX数式対応
- **タイムスタンプリンク**: 台詞引用の時刻表示がYouTube/ニコニコ動画の該当時点へのリンクに
- **軌道図アニメーション**: SVGベースの軌道遷移図。時間スライダーで天体位置の変化をアニメーション
- **エンジン燃焼表示**: 加速・減速・中間修正・軌道投入の4種類の噴射プルーム
- **エピソード間クロスリンク**: 「第N話」への言及を自動的にリンク化

## 字幕・対話パイプライン

作中の台詞を正確に引用するための2段階パイプラインです。

### Phase 1: 抽出

複数のデータソースから生のテキストを取得:
- **YouTube自動字幕** (VTT): `yt-dlp` で取得。VOICEROID音声の認識精度に限界あり
- **Whisper STT**: OpenAI Whisper による音声認識。VTTより15-30%多くのテキストを検出

### Phase 2: 話者帰属

コンテキストを考慮した話者の特定:
- 各発話に話者ID（きりたん、ケイ、etc.）を割り当て
- シーン分割と発話の文脈的修正
- 完全自動化ではなくAI支援による検証

2つのフェーズを別ファイル（`epXX_lines.json` / `epXX_dialogue.json`）で管理することで、Phase 1の再実行がPhase 2の成果を破壊しない設計です。

## テスト戦略

TDD（テスト駆動開発）を原則とし、1,284のテストで品質を保証しています。

### テストの内訳

- **Rust ユニットテスト** (206件): 軌道計算の精度検証。エネルギー保存則、角運動量保存、既知解との比較、RK45適応積分、シンプレクティック積分、重力アシスト
- **TypeScript ユニットテスト** (1,004件): テンプレート出力、データバリデーション、DAG操作、字幕パーサー、WASM結果との整合性
- **Playwright E2E テスト** (74件): 実際のブラウザでページレンダリング検証。テーブルの正常表示、JSエラー検出、内部リンク整合性

### CI パイプライン

GitHub Actions で4つの並列ジョブを実行:
1. **Rust lint + test**: `cargo fmt --check` + `cargo clippy -D warnings` + `cargo test`
2. **TypeScript typecheck + test**: `tsc --noEmit` + `npm test`
3. **Playwright E2E**: サイトビルド + ブラウザテスト
4. **WASM browser build**: `wasm-pack build --target web` の成功を確認

## Claude Code エージェントループ

本プロジェクトは[Anthropicが提唱するパターン](https://www.anthropic.com/engineering/building-c-compiler)に基づき、Claude Codeエージェントが自律的に開発しています。

### ワークフロー

1. **タスク取得**: `current_tasks/` から未着手のタスクを選択
2. **実装**: コード変更、テスト作成、データ更新
3. **検証**: CI相当のチェックをローカルで実行
4. **コミット + プッシュ**: 次のセッションへのハンドオフノートとして機能するコミットメッセージ
5. **セッションログ**: 会話ログを抽出しGitHub Pagesで公開

### 品質管理

- 設計判断時に **Codex（nice-friend skill）** をセカンドオピニオンとして活用
- **レポートレビュースキル** で可読性・正確性を定期的に検証
- **コスト分析** でトークン使用量を最適化（キャッシュ効率97.3%）

### タスク管理

93のタスクファイル（`current_tasks/`）でプロジェクトの進行を追跡。各タスクにステータス（TODO/IN_PROGRESS/DONE）と完了内容を記録し、セッション間の連続性を確保。さらに DAG（有向非巡回グラフ）で分析間の依存関係を管理し、前提変更時の影響範囲を自動追跡しています。

## 分析依存グラフ（DAG）

本プロジェクトの分析は相互に依存しています。船体質量パラメータを変更すれば、それに依存する全24の軌道遷移分析と全レポートの再検証が必要になります。

この依存関係を**有向非巡回グラフ（DAG）**として管理しています。ノードをクリックすると詳細を確認できます。

- **データソース**（青）: Whisper STT、YouTube VTT、設定資料
- **パラメータ**（橙）: 船体質量、推力、比推力など共有前提
- **分析**（緑）: 各エピソードの軌道遷移分析（24件）+ クロスエピソード分析
- **レポート**（紫）: 各話レポート + 総合分析レポート

ノードの**枠色**は検証状態を示します: 有効（緑）、要再検証（橙）、未処理（灰）。

`npm run dag -- invalidate param.ship_mass` のように CLI で前提を無効化すると、影響する全ノードが自動的に「要再検証」としてマークされます。

```dag-viewer:
```

## 設計原則

### 外部依存の最小化

Rust コアは外部クレートゼロ、テンプレートエンジンも外部依存ゼロ。CDN依存は KaTeX（数式レンダリング）のみ。これにより、ビルドの再現性と長期的な保守性を確保。

### 仮定の明示化

すべての分析には前提条件を明記。「世界設定資料に基づく船体質量48,000 t」「JPL平均軌道要素による惑星位置」など、データの出典をトレース可能に。

### SF作品としての評価

物理的に現実的かどうかだけでなく、**作品内で一貫しているか**を重視。人間のG耐性対策や未来の推進技術は受け入れ可能な前提として扱い、経過時間・距離・天体位置の整合性を検証。

### 複数シナリオの探索

一つの不一致を見つけて「非現実的」と結論づけるのではなく、パラメータ空間を探索して**どの条件なら成立するか**を明らかにする。境界条件や許容範囲の議論により、分析の深みを確保。

